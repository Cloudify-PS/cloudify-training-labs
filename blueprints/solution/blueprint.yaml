tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/3.4.1/types.yaml

inputs:
  apache_listening_port:
    type: integer

  # Add an input for the Apache listening port.
  # The input name should be "apache_listening_port", the type should be "integer", with no default.

relationships:
  apache_connected_to_mysql:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        establish:
          implementation: scripts/apache-to-mysql.sh

node_types:
  apache:
    derived_from: cloudify.nodes.Root
    properties:
      listener_port:
        type: integer
        default: 80
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: scripts/apache-install.sh
        delete:
          implementation: scripts/apache-uninstall.sh

  mysql:
    derived_from: cloudify.nodes.Root
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: scripts/mysql-install.sh
        delete:
          implementation: scripts/mysql-uninstall.sh

node_templates:
  host:
    type: cloudify.nodes.Compute
    properties:
      agent_config:
        install_method: none

  web_server:
    type: apache
    properties:
      listener_port: { get_input: apache_listening_port }
    relationships:
      - target: database
        type: apache_connected_to_mysql
      - target: host
        type: cloudify.relationships.contained_in

  database:
    type: mysql
    relationships:
      - target: host
        type: cloudify.relationships.contained_in
